<form
  [formGroup]="serviceForm"
  class="details-section"
  (ngSubmit)="save(false, false)"
  [class]="(isDarkMode | async) ? 'dark-theme' : ''">
  <ng-container *ngIf="this.isDatabase && !this.edit; else notDatabaseEdit">
    <mat-stepper linear #stepper>
      <mat-step errorMessage="Service Type is required." [editable]="true">
        <ng-template matStepLabel>
          {{ 'services.controls.serviceType.label' | transloco }}</ng-template
        >
        <div class="details-section">
          <div class="section-header">
            <h3>
              Search for your
              {{ 'services.controls.serviceType.label' | transloco }} to get
              started
              <fa-icon
                class="tool-tip-trigger"
                matSuffix
                [icon]="faCircleInfo"
                [matTooltip]="
                  'services.controls.serviceType.tooltip' | transloco
                " />
            </h3>
            <div>
              <button
                mat-button
                matStepperNext
                type="button"
                class="cancel-btn"
                [disabled]="serviceForm.get('type')?.value === ''">
                Next
              </button>
            </div>
          </div>
          <mat-form-field class="dynamic-width" appearance="outline">
            <mat-label>Search service types...</mat-label>
            <input
              matInput
              [(ngModel)]="search"
              placeholder="SQL, AWS, MongoDB, etc."
              [ngModelOptions]="{ standalone: true }" />
          </mat-form-field>
          <div class="full-width">
            <div class="grid-wrapper grid-col-auto">
              <label
                class="radio-card"
                *ngFor="let type of filteredServiceTypes; let i = index">
                <input
                  formControlName="type"
                  type="radio"
                  [value]="type.name"
                  (input)="nextStep(stepper)" />
                <div class="card-content-wrapper" [class]="type.class">
                  <span class="check-icon"></span>
                  <div class="card-content">
                    <img
                      class="card-icon"
                      [src]="getBackgroundImage(type.name)"
                      [alt]="type.label" />
                    <h4>
                      {{ type.label }}
                    </h4>
                  </div>
                </div>
              </label>
              <label
                class="radio-card"
                *ngFor="let type of notIncludedServices; let i = index">
                <input
                  formControlName="type"
                  type="radio"
                  [value]="type.name"
                  (input)="nextStep(stepper)"
                  [attr.disabled]="true" />
                <div class="card-content-wrapper" [class]="type.class">
                  <span class="check-icon"></span>
                  <div class="card-content">
                    <img
                      class="card-icon"
                      [src]="getBackgroundImage(type.name)"
                      [alt]="type.label" />
                    <h4 class="text-center" style="color: black !important">
                      {{ type.label }}
                    </h4>
                  </div>
                </div>
                <ng-container *ngIf="type.class === 'not-included'">
                  <button
                    mat-button
                    (click)="openDialog(type.label || type.name)"
                    class="unlock-btn">
                    Unlock Now
                  </button>
                </ng-container>
              </label>
            </div>
          </div>
          <div>
            <button
              mat-button
              matStepperNext
              type="button"
              class="cancel-btn"
              [disabled]="serviceForm.get('type')?.value === ''">
              Next
            </button>
          </div>
        </div>
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Service Details</ng-template>
        <br />
        <div class="details-section">
          <!-- Equal-width row for Namespace and Label -->
          <div *ngIf="!subscriptionRequired" style="display: flex; gap: 16px; width: 100%; margin-bottom: 8px;">
            <mat-form-field
              subscriptSizing="fixed"
              style="flex: 1;"
              appearance="outline">
              <mat-label>{{
                'services.controls.namespace.label' | transloco
              }}</mat-label>
              <input matInput formControlName="name" />
              <fa-icon
                class="tool-tip-trigger"
                matSuffix
                [icon]="faCircleInfo"
                [matTooltip]="
                  'services.controls.namespace.tooltip' | transloco
                " />
              <mat-hint>
                API URL: /api/v2/<strong>{{ serviceForm.get('name')?.value || 'your-name' }}</strong>/_table/... (lowercase, no spaces)
              </mat-hint>
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              subscriptSizing="fixed"
              style="flex: 1;">
              <mat-label>{{
                'services.controls.label.label' | transloco
              }}</mat-label>
              <input matInput formControlName="label" />
              <fa-icon
                class="tool-tip-trigger"
                matSuffix
                [icon]="faCircleInfo"
                [matTooltip]="'services.controls.label.tooltip' | transloco" />
              <mat-hint>Display name shown in the UI</mat-hint>
            </mat-form-field>
          </div>
          <mat-form-field
            appearance="outline"
            subscriptSizing="dynamic"
            class="full-width"
            *ngIf="!subscriptionRequired">
            <mat-label>{{
              'services.controls.description.label' | transloco
            }}</mat-label>
            <textarea
              rows="1"
              matInput
              formControlName="description"></textarea>
            <fa-icon
              class="tool-tip-trigger"
              matSuffix
              [icon]="faCircleInfo"
              [matTooltip]="
                'services.controls.description.tooltip' | transloco
              " />
          </mat-form-field>
          <div class="action-container">
            <mat-slide-toggle
              color="primary"
              formControlName="isActive"
              *ngIf="!subscriptionRequired"
              >{{ 'active' | transloco }}</mat-slide-toggle
            >
            <div>
              <button
                mat-button
                matStepperPrevious
                class="cancel-btn"
                type="button">
                Back
              </button>
              <button
                mat-button
                matStepperNext
                type="button"
                class="cancel-btn"
                [disabled]="
                  serviceForm.get('type')?.value === '' &&
                  serviceForm.get('description')?.value === ''
                ">
                Next
              </button>
            </div>
            <div></div>
          </div>
        </div>
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Service Options</ng-template>
        <br />

        <ng-container *ngIf="viewSchema && !subscriptionRequired">
          <ng-container formGroupName="config">
            <ng-container *ngIf="!isDatabase || !hasStandardFields">
              <mat-accordion class="full-width">
                <div class="details-section">
                  <ng-container *ngFor="let item of viewSchema">
                    <ng-container
                      *ngIf="
                        item.type === 'text' && item.name === 'content';
                        else dynamic
                      ">
                      <ng-container
                        *ngIf="getConfigControl('storageServiceId')">
                        <df-script-editor
                          [type]="getControl('type')"
                          [storageServiceId]="
                            getConfigControl('storageServiceId')
                          "
                          [storagePath]="getConfigControl('storagePath')"
                          [content]="getServiceDocByServiceIdControl('content')"
                          [cache]="serviceData ? serviceData.name : ''"
                          class="full-width">
                        </df-script-editor>
                      </ng-container>
                    </ng-container>
                    <ng-template #dynamic>
                      <df-dynamic-field
                        *ngIf="
                          [
                            'integer',
                            'password',
                            'string',
                            'text',
                            'picklist',
                            'multi_picklist',
                            'boolean',
                            'file_certificate',
                            'file_certificate_api',
                          ].includes(item.type)
                        "
                        [schema]="item"
                        [formControl]="getConfigControl(item.name)"
                        [class.dynamic-width]="
                          ['file_certificate', 'file_certificate_api'].indexOf(
                            item.type
                          ) === -1
                        "
                        [class.full-width]="
                          ['file_certificate', 'file_certificate_api'].indexOf(
                            item.type
                          ) !== -1
                        "></df-dynamic-field>
                      <df-array-field
                        *ngIf="item.type === 'array' || item.type === 'object'"
                        [schema]="item"
                        [formControl]="getConfigControl(item.name)"
                        class="full-width">
                      </df-array-field>
                    </ng-template>
                  </ng-container>
                </div>
              </mat-accordion>

              <!-- OAuth Test Button for Snowflake (in generic layout) -->
              <div
                class="full-width oauth-check-section"
                *ngIf="getControl('type')?.value === 'snowflake'"
                style="margin-top: 20px">
                <button
                  mat-raised-button
                  color="primary"
                  type="button"
                  [disabled]="oauthCheckInProgress"
                  (click)="testSnowflakeOAuth()">
                  <mat-icon *ngIf="!oauthCheckInProgress"
                    >check_circle</mat-icon
                  >
                  <mat-spinner
                    *ngIf="oauthCheckInProgress"
                    diameter="20"></mat-spinner>
                  {{
                    oauthCheckInProgress
                      ? 'Checking...'
                      : 'Test OAuth Connection'
                  }}
                </button>
                <p
                  class="oauth-message"
                  *ngIf="oauthCheckMessage"
                  [ngClass]="{
                    success: oauthCheckSuccess,
                    error: !oauthCheckSuccess && oauthCheckMessage,
                  }">
                  {{ oauthCheckMessage }}
                </p>
              </div>
            </ng-container>

            <!-- Snowflake-specific UI layout -->
            <ng-container *ngIf="isSnowflake">
              <!-- Native App Mode: Simplified form with only user-configurable fields -->
              <div
                *ngIf="isNativeApp"
                class="native-app-notice"
                style="
                  background: #e3f2fd;
                  padding: 12px;
                  border-radius: 4px;
                  margin-bottom: 16px;
                ">
                <strong>Snowflake Native App Mode</strong>
                <p style="margin: 4px 0 0 0; font-size: 13px">
                  OAuth authentication is automatically configured. Just specify
                  your database connection details below.
                </p>
              </div>

              <div class="details-section basic-fields-section">
                <!-- Native App: Show only user-configurable fields -->
                <ng-container *ngIf="isNativeApp">
                  <ng-container *ngFor="let item of snowflakeNativeAppFields">
                    <df-dynamic-field
                      *ngIf="
                        [
                          'integer',
                          'password',
                          'string',
                          'text',
                          'picklist',
                          'multi_picklist',
                          'boolean',
                        ].includes(item.type)
                      "
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      class="dynamic-width">
                    </df-dynamic-field>
                  </ng-container>
                </ng-container>

                <!-- Standard Mode: Show all basic fields -->
                <ng-container *ngIf="!isNativeApp">
                  <ng-container *ngFor="let item of snowflakeBasicFields">
                    <df-dynamic-field
                      *ngIf="
                        [
                          'integer',
                          'password',
                          'string',
                          'text',
                          'picklist',
                          'multi_picklist',
                          'boolean',
                          'file_certificate',
                          'file_certificate_api',
                        ].includes(item.type)
                      "
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      [class.dynamic-width]="
                        item.type !== 'file_certificate' &&
                        item.type !== 'file_certificate_api'
                      "
                      [class.full-width]="
                        item.type === 'file_certificate' ||
                        item.type === 'file_certificate_api'
                      ">
                    </df-dynamic-field>
                    <df-array-field
                      *ngIf="item.type === 'array' || item.type === 'object'"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      class="full-width">
                    </df-array-field>
                  </ng-container>
                </ng-container>

                <!-- OAuth Token Check Button (for Native App users) -->
                <div class="full-width oauth-check-section">
                  <button
                    mat-raised-button
                    color="primary"
                    type="button"
                    [disabled]="oauthCheckInProgress"
                    (click)="testSnowflakeOAuth()">
                    <mat-icon *ngIf="!oauthCheckInProgress"
                      >check_circle</mat-icon
                    >
                    <mat-spinner
                      *ngIf="oauthCheckInProgress"
                      diameter="20"></mat-spinner>
                    {{
                      oauthCheckInProgress
                        ? 'Checking...'
                        : 'Test OAuth Connection'
                    }}
                  </button>
                  <p
                    class="oauth-message"
                    *ngIf="oauthCheckMessage"
                    [ngClass]="{
                      success: oauthCheckSuccess,
                      error: !oauthCheckSuccess && oauthCheckMessage,
                    }">
                    {{ oauthCheckMessage }}
                  </p>
                </div>
              </div>

              <div
                class="advanced-section"
                *ngIf="showSnowflakeAdvancedOptions">
                <mat-accordion class="full-width">
                  <mat-expansion-panel [expanded]="false">
                    <mat-expansion-panel-header>
                      Advanced Options
                    </mat-expansion-panel-header>
                    <div class="details-section">
                      <ng-container
                        *ngFor="let item of snowflakeAdvancedFields">
                        <df-dynamic-field
                          *ngIf="
                            [
                              'integer',
                              'password',
                              'string',
                              'text',
                              'picklist',
                              'multi_picklist',
                              'boolean',
                              'file_certificate',
                              'file_certificate_api',
                            ].includes(item.type)
                          "
                          [schema]="item"
                          [formControl]="getConfigControl(item.name)"
                          [class.dynamic-width]="
                            item.type !== 'file_certificate' &&
                            item.type !== 'file_certificate_api'
                          "
                          [class.full-width]="
                            item.type === 'file_certificate' ||
                            item.type === 'file_certificate_api'
                          ">
                        </df-dynamic-field>
                        <df-array-field
                          *ngIf="
                            item.type === 'array' || item.type === 'object'
                          "
                          [schema]="item"
                          [formControl]="getConfigControl(item.name)"
                          class="full-width">
                        </df-array-field>
                      </ng-container>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </ng-container>

            <!-- Standard database UI layout -->
            <ng-container
              *ngIf="isDatabase && hasStandardFields && !isSnowflake">
              <div class="details-section basic-fields-section">
                <ng-container *ngFor="let item of basicFields">
                  <df-dynamic-field
                    *ngIf="
                      [
                        'integer',
                        'password',
                        'string',
                        'text',
                        'picklist',
                        'multi_picklist',
                        'boolean',
                        'file_certificate',
                        'file_certificate_api',
                      ].includes(item.type)
                    "
                    [schema]="item"
                    [formControl]="getConfigControl(item.name)"
                    [class.dynamic-width]="item.type !== 'file_certificate'"
                    [class.full-width]="item.type === 'file_certificate'">
                  </df-dynamic-field>
                  <df-array-field
                    *ngIf="item.type === 'array' || item.type === 'object'"
                    [schema]="item"
                    [formControl]="getConfigControl(item.name)"
                    class="full-width">
                  </df-array-field>
                </ng-container>
              </div>

              <!-- OAuth Test Button for Snowflake (in standard database layout) -->
              <div
                class="full-width oauth-check-section"
                *ngIf="getControl('type')?.value === 'snowflake'"
                style="margin-top: 20px">
                <button
                  mat-raised-button
                  color="primary"
                  type="button"
                  [disabled]="oauthCheckInProgress"
                  (click)="testSnowflakeOAuth()">
                  <mat-icon *ngIf="!oauthCheckInProgress"
                    >check_circle</mat-icon
                  >
                  <mat-spinner
                    *ngIf="oauthCheckInProgress"
                    diameter="20"></mat-spinner>
                  {{
                    oauthCheckInProgress
                      ? 'Checking...'
                      : 'Test OAuth Connection'
                  }}
                </button>
                <p
                  class="oauth-message"
                  *ngIf="oauthCheckMessage"
                  [ngClass]="{
                    success: oauthCheckSuccess,
                    error: !oauthCheckSuccess && oauthCheckMessage,
                  }">
                  {{ oauthCheckMessage }}
                </p>
              </div>

              <div class="advanced-section" *ngIf="showAdvancedOptions">
                <mat-accordion class="full-width">
                  <mat-expansion-panel [expanded]="false">
                    <mat-expansion-panel-header>
                      {{ 'services.options' | transloco }}
                    </mat-expansion-panel-header>
                    <div class="details-section">
                      <ng-container *ngFor="let item of advancedFields">
                        <ng-container
                          *ngIf="
                            item.type === 'text' && item.name === 'content';
                            else dynamic
                          ">
                          <ng-container
                            *ngIf="getConfigControl('storageServiceId')">
                            <df-script-editor
                              [type]="getControl('type')"
                              [storageServiceId]="
                                getConfigControl('storageServiceId')
                              "
                              [storagePath]="getConfigControl('storagePath')"
                              [content]="
                                getServiceDocByServiceIdControl('content')
                              "
                              [cache]="serviceData ? serviceData.name : ''"
                              class="full-width">
                            </df-script-editor>
                          </ng-container>
                        </ng-container>
                        <ng-template #dynamic>
                          <df-dynamic-field
                            *ngIf="
                              [
                                'integer',
                                'password',
                                'string',
                                'text',
                                'picklist',
                                'multi_picklist',
                                'boolean',
                                'file_certificate',
                                'file_certificate_api',
                              ].includes(item.type)
                            "
                            [schema]="item"
                            [formControl]="getConfigControl(item.name)"
                            [class.dynamic-width]="
                              item.type !== 'file_certificate' &&
                              item.type !== 'file_certificate_api'
                            "
                            [class.full-width]="
                              item.type === 'file_certificate' ||
                              item.type === 'file_certificate_api'
                            ">
                          </df-dynamic-field>
                          <df-array-field
                            *ngIf="
                              item.type === 'array' || item.type === 'object'
                            "
                            [schema]="item"
                            [formControl]="getConfigControl(item.name)"
                            class="full-width">
                          </df-array-field>
                        </ng-template>
                      </ng-container>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
        <!-- First-time user guidance message for database services -->
        <div
          class="first-time-guidance"
          *ngIf="isFirstTimeUser && isDatabase && !subscriptionRequired">
          <fa-icon [icon]="faCircleInfo" class="guidance-icon"></fa-icon>
          <p class="guidance-text">
            {{ 'services.firstTimeGuidance' | transloco }}
          </p>
        </div>

        <div class="full-width action-bar" *ngIf="!subscriptionRequired">
          <button
            class="cancel-btn"
            mat-flat-button
            type="button"
            (click)="goBack()">
            {{ 'cancel' | transloco }}
          </button>
          <div class="button-group">
            <!-- Native App Mode: Simplified button that skips security config -->
            <button
              *ngIf="isNativeApp && isSnowflake"
              mat-flat-button
              class="save-btn"
              color="primary"
              type="button"
              [disabled]="!serviceForm.valid"
              (click)="goToSecurityConfig()">
              Create & View API Docs
            </button>

            <!-- For first-time users creating database APIs (non-native app), only show Security Config button as primary -->
            <button
              *ngIf="
                isFirstTimeUser && isDatabase && !(isNativeApp && isSnowflake)
              "
              mat-flat-button
              class="save-btn"
              color="primary"
              type="button"
              [disabled]="!serviceForm.valid"
              (click)="goToSecurityConfig()">
              {{ 'services.controls.nextSecurityConfig' | transloco }}
            </button>

            <!-- For experienced users or non-database services (non-native app), show both buttons -->
            <button
              *ngIf="
                !(isFirstTimeUser && isDatabase) &&
                !(isNativeApp && isSnowflake)
              "
              mat-flat-button
              class="save-btn secondary-btn"
              type="button"
              [disabled]="!serviceForm.valid"
              (click)="goToSecurityConfig()">
              {{ 'services.controls.securityConfig' | transloco }}
            </button>
            <button
              *ngIf="
                !(isFirstTimeUser && isDatabase) &&
                !(isNativeApp && isSnowflake)
              "
              class="save-btn"
              mat-flat-button
              color="primary">
              {{ 'services.controls.createAndTest' | transloco }}
            </button>
          </div>
        </div>
      </mat-step>
      <mat-step>
        <ng-template matStepLabel>Security Configuration</ng-template>
        <div class="details-section" *ngIf="showSecurityConfig">
          <df-security-config
            [serviceName]="serviceForm.get('name')?.value"
            [serviceId]="currentServiceId"
            [isDatabase]="isDatabase"
            [isFirstTimeUser]="isFirstTimeUser"
            (goBack)="goBack()">
          </df-security-config>
        </div>
        <div class="details-section" *ngIf="!showSecurityConfig">
          <p>
            Please complete the previous steps and click "Security Config" to
            configure security settings.
          </p>
          <div class="action-container">
            <div>
              <button
                mat-button
                matStepperPrevious
                class="cancel-btn"
                type="button">
                Back
              </button>
            </div>
          </div>
        </div>
      </mat-step>
      <ng-template matStepperIcon="edit" let-index="index">
        <ng-container [ngSwitch]="index">
          <mat-icon *ngSwitchCase="0">1</mat-icon>
          <mat-icon *ngSwitchCase="1">2</mat-icon>
          <mat-icon *ngSwitchCase="2">3</mat-icon>
          <mat-icon *ngSwitchCase="3">4</mat-icon>
        </ng-container>
      </ng-template>
      <ng-template matStepperIcon="done" let-index="index">
        <ng-container [ngSwitch]="index">
          <mat-icon *ngSwitchCase="0">1</mat-icon>
          <mat-icon *ngSwitchCase="1">2</mat-icon>
          <mat-icon *ngSwitchCase="2">3</mat-icon>
          <mat-icon *ngSwitchCase="3">4</mat-icon>
        </ng-container>
      </ng-template>
    </mat-stepper>
  </ng-container>
  <ng-template #notDatabaseEdit>
    <mat-form-field
      subscriptSizing="dynamic"
      class="dynamic-width"
      appearance="outline">
      <mat-label>{{
        'services.controls.serviceType.label' | transloco
      }}</mat-label>
      <mat-select
        formControlName="type"
        (selectionChange)="
          onServiceTypeSelect(getServiceTypeLabel($event.value))
        ">
        <mat-option *ngFor="let type of serviceTypes" [value]="type.name">
          {{ type.label }}
        </mat-option>
      </mat-select>
      <fa-icon
        class="tool-tip-trigger"
        matSuffix
        [icon]="faCircleInfo"
        [matTooltip]="'services.controls.serviceType.tooltip' | transloco" />
    </mat-form-field>

    <mat-form-field
      subscriptSizing="dynamic"
      class="dynamic-width"
      appearance="outline"
      *ngIf="!subscriptionRequired">
      <mat-label>{{
        'services.controls.namespace.label' | transloco
      }}</mat-label>
      <input matInput formControlName="name" />
      <fa-icon
        class="tool-tip-trigger"
        matSuffix
        [icon]="faCircleInfo"
        [matTooltip]="'services.controls.namespace.tooltip' | transloco" />
    </mat-form-field>

    <!-- Excel Service Configuration -->
    <ng-container *ngIf="serviceForm.getRawValue().type === 'excel'">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Storage Service *</mat-label>
        <mat-select formControlName="storageServiceId" required>
          <mat-option
            *ngFor="let service of availableFileServices"
            [value]="service.id">
            {{ service.label || service.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-container>
    <mat-form-field
      subscriptSizing="dynamic"
      appearance="outline"
      class="full-width"
      *ngIf="!subscriptionRequired">
      <mat-label>{{ 'services.controls.label.label' | transloco }}</mat-label>
      <input matInput formControlName="label" />
      <fa-icon
        class="tool-tip-trigger"
        matSuffix
        [icon]="faCircleInfo"
        [matTooltip]="'services.controls.label.tooltip' | transloco" />
    </mat-form-field>
    <mat-form-field
      subscriptSizing="dynamic"
      class="full-width"
      appearance="outline"
      *ngIf="!subscriptionRequired">
      <mat-label>{{
        'services.controls.description.label' | transloco
      }}</mat-label>
      <textarea rows="1" matInput formControlName="description"></textarea>
      <fa-icon
        class="tool-tip-trigger"
        matSuffix
        [icon]="faCircleInfo"
        [matTooltip]="'services.controls.description.tooltip' | transloco" />
    </mat-form-field>
    <mat-slide-toggle
      formControlName="isActive"
      color="primary"
      *ngIf="!subscriptionRequired"
      ><span>{{ 'active' | transloco }}</span></mat-slide-toggle
    >
    <div class="full-width">
      <ng-container *ngIf="this.edit">
        <ng-container *ngIf="this.isDatabase; else notDatabase">
          <button
            type="button"
            mat-flat-button
            class="save-btn"
            (click)="gotoSchema()">
            {{ 'schema' | transloco }}
          </button>
        </ng-container>
        <ng-template #notDatabase>
          <button
            type="button"
            mat-flat-button
            class="save-btn"
            (click)="gotoAPIDocs()">
            {{ 'apiDocs' | transloco }}
          </button>
        </ng-template>
      </ng-container>
    </div>
    <ng-container *ngIf="viewSchema && !subscriptionRequired">
      <ng-container formGroupName="config">
        <!-- Network Service Configuration -->
        <ng-container *ngIf="this.isNetworkService">
          <!-- Required Fields (Base URL) - Always visible at the top -->
          <ng-container *ngFor="let item of networkRequiredFields">
            <df-dynamic-field
              *ngIf="
                [
                  'integer',
                  'password',
                  'string',
                  'text',
                  'picklist',
                  'multi_picklist',
                  'boolean',
                  'file_certificate',
                  'file_certificate_api',
                ].includes(item.type)
              "
              color="primary"
              [schema]="item"
              [formControl]="getConfigControl(item.name)"
              [class.dynamic-width]="
                ['file_certificate', 'file_certificate_api'].indexOf(
                  item.type
                ) === -1
              "
              [class.full-width]="
                ['file_certificate', 'file_certificate_api'].indexOf(
                  item.type
                ) !== -1
              "></df-dynamic-field>
          </ng-container>

          <!-- Advanced Options Section for Network Services -->
          <mat-accordion class="full-width">
            <mat-expansion-panel [expanded]="false">
              <mat-expansion-panel-header>
                Advanced Options
              </mat-expansion-panel-header>
              <div class="details-section">
                <!-- Service Definition Section -->
                <ng-container *ngIf="serviceForm.getRawValue().type !== 'soap'">
                  <mat-button-toggle-group
                    aria-label="Service Definition Type"
                    [(ngModel)]="serviceDefinitionType"
                    [ngModelOptions]="{ standalone: true }"
                    (change)="
                      onServiceDefinitionTypeChange(serviceDefinitionType)
                    ">
                    <mat-button-toggle value="0">JSON</mat-button-toggle>
                    <mat-button-toggle value="1">YAML</mat-button-toggle>
                  </mat-button-toggle-group>
                </ng-container>
                <mat-label class="full-width">Service Definition</mat-label>

                <ng-container *ngIf="serviceForm.getRawValue().type === 'rws'">
                  <df-file-github
                    [type]="getControl('type')"
                    [content]="getConfigControl('content')"
                    [contentText]="content"
                    class="full-width">
                  </df-file-github>
                </ng-container>

                <ng-container *ngIf="serviceForm.getRawValue().type === 'soap'">
                  <df-file-github
                    [type]="getControl('type')"
                    [content]="getConfigControl('content')"
                    [contentText]="content"
                    class="full-width">
                  </df-file-github>
                </ng-container>

                <ng-container
                  *ngIf="
                    serviceForm.getRawValue().type === 'rest' ||
                    serviceForm.getRawValue().type === 'http'
                  ">
                  <df-ace-editor
                    class="full-width"
                    [formControl]="getConfigControl('content')"
                    [mode]="serviceDefinitionMode">
                  </df-ace-editor>
                </ng-container>

                <!-- Other Advanced Fields -->
                <ng-container *ngFor="let item of networkAdvancedFields">
                  <df-dynamic-field
                    *ngIf="
                      [
                        'integer',
                        'password',
                        'string',
                        'text',
                        'picklist',
                        'multi_picklist',
                        'boolean',
                        'file_certificate',
                        'file_certificate_api',
                      ].includes(item.type)
                    "
                    color="primary"
                    [schema]="item"
                    [formControl]="getConfigControl(item.name)"
                    [class.dynamic-width]="
                      ['file_certificate', 'file_certificate_api'].indexOf(
                        item.type
                      ) === -1
                    "
                    [class.full-width]="
                      ['file_certificate', 'file_certificate_api'].indexOf(
                        item.type
                      ) !== -1
                    "></df-dynamic-field>
                  <df-array-field
                    *ngIf="item.type === 'array' || item.type === 'object'"
                    [schema]="item"
                    [formControl]="getConfigControl(item.name)"
                    class="full-width"></df-array-field>
                </ng-container>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </ng-container>

        <!-- Script Service Configuration -->
        <ng-container *ngIf="this.isScriptService">
          <!-- Script Content - Always visible -->
          <ng-container *ngIf="getConfigControl('storageServiceId')">
            <df-script-editor
              [isScript]="this.isScriptService"
              [type]="getControl('type')"
              [storageServiceId]="getConfigControl('storageServiceId')"
              [storagePath]="getConfigControl('storagePath')"
              [content]="getConfigControl('content')"
              [cache]="serviceData ? serviceData.name : ''"
              class="full-width"></df-script-editor>
          </ng-container>

          <!-- Advanced Options Section for Script Services -->
          <mat-accordion class="full-width">
            <mat-expansion-panel [expanded]="false">
              <mat-expansion-panel-header>
                Advanced Options
              </mat-expansion-panel-header>
              <div class="details-section">
                <!-- OpenAPI Service Definition Section -->
                <mat-button-toggle-group
                  aria-label="Service Definition Type"
                  [(ngModel)]="serviceDefinitionType"
                  [ngModelOptions]="{ standalone: true }"
                  (change)="
                    onServiceDefinitionTypeChange(serviceDefinitionType)
                  ">
                  <mat-button-toggle value="0">JSON</mat-button-toggle>
                  <mat-button-toggle value="1">YAML</mat-button-toggle>
                </mat-button-toggle-group>
                <mat-label class="full-width"
                  >OpenAPI Service Definition (Optional)</mat-label
                >

                <df-ace-editor
                  class="full-width"
                  [formControl]="getServiceDocByServiceIdControl('content')"
                  [mode]="serviceDefinitionMode">
                </df-ace-editor>

                <!-- Other configuration fields if any -->
                <ng-container *ngFor="let item of viewSchema">
                  <ng-container *ngIf="item.name !== 'content'">
                    <df-dynamic-field
                      *ngIf="
                        [
                          'integer',
                          'password',
                          'string',
                          'text',
                          'picklist',
                          'multi_picklist',
                          'boolean',
                          'file_certificate',
                          'file_certificate_api',
                        ].includes(item.type)
                      "
                      color="primary"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      [class.dynamic-width]="
                        ['file_certificate', 'file_certificate_api'].indexOf(
                          item.type
                        ) === -1
                      "
                      [class.full-width]="
                        ['file_certificate', 'file_certificate_api'].indexOf(
                          item.type
                        ) !== -1
                      "></df-dynamic-field>
                    <df-array-field
                      *ngIf="item.type === 'array' || item.type === 'object'"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      class="full-width"></df-array-field>
                  </ng-container>
                </ng-container>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </ng-container>

        <!-- Snowflake Service Configuration (Edit Mode) -->
        <ng-container *ngIf="this.isSnowflake">
          <!-- Native App Mode: Simplified form with only user-configurable fields -->
          <div
            *ngIf="isNativeApp"
            class="native-app-notice"
            style="
              background: #e3f2fd;
              padding: 12px;
              border-radius: 4px;
              margin-bottom: 16px;
            ">
            <strong>Snowflake Native App Mode</strong>
            <p style="margin: 4px 0 0 0; font-size: 13px">
              OAuth authentication is automatically configured. Just specify
              your database connection details below.
            </p>
          </div>

          <!-- OAuth Token Status Display -->
          <div
            *ngIf="oauthTokenStatus && isNativeApp"
            class="oauth-status-card"
            style="
              background: #f5f5f5;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 16px;
              margin-bottom: 16px;
            ">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
              ">
              <mat-icon
                [style.color]="
                  oauthTokenStatus.authorized && !oauthTokenStatus.is_expired
                    ? '#4caf50'
                    : '#f44336'
                ">
                {{
                  oauthTokenStatus.authorized && !oauthTokenStatus.is_expired
                    ? 'check_circle'
                    : 'error'
                }}
              </mat-icon>
              <strong style="font-size: 14px">
                OAuth Token Status:
                {{
                  oauthTokenStatus.authorized && !oauthTokenStatus.is_expired
                    ? 'Active'
                    : 'Needs Refresh'
                }}
              </strong>
            </div>
            <div style="font-size: 13px; color: #666">
              <div
                *ngIf="oauthTokenStatus.spcs_token_available"
                style="margin-bottom: 4px">
                <mat-icon
                  style="
                    font-size: 16px;
                    width: 16px;
                    height: 16px;
                    vertical-align: middle;
                    color: #2196f3;
                  "
                  >cloud</mat-icon
                >
                SPCS Session Token: Available
              </div>
              <div *ngIf="oauthTokenStatus.expires_at">
                Token Expires:
                {{ oauthTokenStatus.expires_at | date: 'medium' }}
              </div>
              <div
                *ngIf="
                  !oauthTokenStatus.expires_at &&
                  oauthTokenStatus.spcs_token_available
                ">
                Token managed by Snowflake Container Services
              </div>
            </div>
          </div>

          <!-- Loading state for OAuth status -->
          <div
            *ngIf="oauthStatusLoading && isNativeApp"
            style="
              margin-bottom: 16px;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
            <mat-spinner diameter="20"></mat-spinner>
            <span style="font-size: 13px; color: #666"
              >Loading token status...</span
            >
          </div>

          <div class="details-section basic-fields-section">
            <!-- Native App: Show only user-configurable fields -->
            <ng-container *ngIf="isNativeApp">
              <ng-container *ngFor="let item of snowflakeNativeAppFields">
                <df-dynamic-field
                  *ngIf="
                    [
                      'integer',
                      'password',
                      'string',
                      'text',
                      'picklist',
                      'multi_picklist',
                      'boolean',
                    ].includes(item.type)
                  "
                  [schema]="item"
                  [formControl]="getConfigControl(item.name)"
                  class="dynamic-width">
                </df-dynamic-field>
              </ng-container>
            </ng-container>

            <!-- Standard Mode: Show all basic fields -->
            <ng-container *ngIf="!isNativeApp">
              <ng-container *ngFor="let item of snowflakeBasicFields">
                <df-dynamic-field
                  *ngIf="
                    [
                      'integer',
                      'password',
                      'string',
                      'text',
                      'picklist',
                      'multi_picklist',
                      'boolean',
                      'file_certificate',
                      'file_certificate_api',
                    ].includes(item.type)
                  "
                  [schema]="item"
                  [formControl]="getConfigControl(item.name)"
                  [class.dynamic-width]="
                    item.type !== 'file_certificate' &&
                    item.type !== 'file_certificate_api'
                  "
                  [class.full-width]="
                    item.type === 'file_certificate' ||
                    item.type === 'file_certificate_api'
                  ">
                </df-dynamic-field>
                <df-array-field
                  *ngIf="item.type === 'array' || item.type === 'object'"
                  [schema]="item"
                  [formControl]="getConfigControl(item.name)"
                  class="full-width">
                </df-array-field>
              </ng-container>
            </ng-container>

            <!-- OAuth Token Check Button -->
            <div class="full-width oauth-check-section">
              <button
                mat-raised-button
                color="primary"
                type="button"
                [disabled]="oauthCheckInProgress"
                (click)="testSnowflakeOAuth()">
                <mat-icon *ngIf="!oauthCheckInProgress">check_circle</mat-icon>
                <mat-spinner
                  *ngIf="oauthCheckInProgress"
                  diameter="20"></mat-spinner>
                {{
                  oauthCheckInProgress ? 'Checking...' : 'Test OAuth Connection'
                }}
              </button>
              <p
                class="oauth-message"
                *ngIf="oauthCheckMessage"
                [ngClass]="{
                  success: oauthCheckSuccess,
                  error: !oauthCheckSuccess && oauthCheckMessage,
                }">
                {{ oauthCheckMessage }}
              </p>
            </div>
          </div>

          <div class="advanced-section" *ngIf="showSnowflakeAdvancedOptions">
            <mat-accordion class="full-width">
              <mat-expansion-panel [expanded]="false">
                <mat-expansion-panel-header>
                  Advanced Options
                </mat-expansion-panel-header>
                <div class="details-section">
                  <ng-container *ngFor="let item of snowflakeAdvancedFields">
                    <df-dynamic-field
                      *ngIf="
                        [
                          'integer',
                          'password',
                          'string',
                          'text',
                          'picklist',
                          'multi_picklist',
                          'boolean',
                          'file_certificate',
                          'file_certificate_api',
                        ].includes(item.type)
                      "
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      [class.dynamic-width]="
                        item.type !== 'file_certificate' &&
                        item.type !== 'file_certificate_api'
                      "
                      [class.full-width]="
                        item.type === 'file_certificate' ||
                        item.type === 'file_certificate_api'
                      ">
                    </df-dynamic-field>
                    <df-array-field
                      *ngIf="item.type === 'array' || item.type === 'object'"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      class="full-width">
                    </df-array-field>
                  </ng-container>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </ng-container>

        <!-- Other Service Types (unchanged) -->
        <ng-container
          *ngIf="
            !this.isNetworkService && !this.isScriptService && !this.isSnowflake
          ">
          <mat-accordion class="full-width">
            <mat-expansion-panel [expanded]="serviceForm.getRawValue().type">
              <mat-expansion-panel-header
                >{{ 'services.options' | transloco }}
              </mat-expansion-panel-header>
              <div class="details-section">
                <ng-container
                  *ngIf="
                    this.isFile &&
                    serviceForm.getRawValue().type === 'local_file'
                  ">
                  <div class="actions full-width">
                    <input
                      type="file"
                      [accept]=""
                      #fileInput
                      (change)="excelUpload($event)"
                      style="display: none" />
                    <button
                      type="button"
                      mat-flat-button
                      class="save-btn"
                      (click)="fileInput.click()">
                      Upload Excel
                    </button>
                  </div>
                  <df-ace-editor
                    class="full-width"
                    [formControl]="getConfigControl('excelContent')"
                    [mode]="excelMode"></df-ace-editor>
                </ng-container>
                <ng-container *ngFor="let item of viewSchema">
                  <ng-container
                    *ngIf="
                      item.type === 'text' && item.name === 'content';
                      else dynamic
                    ">
                    <ng-container *ngIf="getConfigControl('storageServiceId')">
                      <df-script-editor
                        [type]="getControl('type')"
                        [storageServiceId]="
                          getConfigControl('storageServiceId')
                        "
                        [storagePath]="getConfigControl('storagePath')"
                        [content]="getServiceDocByServiceIdControl('content')"
                        [cache]="serviceData ? serviceData.name : ''"
                        class="full-width"></df-script-editor>
                    </ng-container>
                  </ng-container>
                  <ng-template #dynamic>
                    <df-dynamic-field
                      *ngIf="
                        [
                          'integer',
                          'password',
                          'string',
                          'text',
                          'picklist',
                          'multi_picklist',
                          'boolean',
                          'file_certificate',
                          'file_certificate_api',
                        ].includes(item.type)
                      "
                      color="primary"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      [class.dynamic-width]="
                        ['file_certificate', 'file_certificate_api'].indexOf(
                          item.type
                        ) === -1
                      "
                      [class.full-width]="
                        ['file_certificate', 'file_certificate_api'].indexOf(
                          item.type
                        ) !== -1
                      "></df-dynamic-field>
                    <df-array-field
                      *ngIf="item.type === 'array' || item.type === 'object'"
                      [schema]="item"
                      [formControl]="getConfigControl(item.name)"
                      class="full-width"></df-array-field>
                  </ng-template>
                </ng-container>

                <!-- OAuth Test Button for Snowflake (in edit mode) -->
                <div
                  class="full-width oauth-check-section"
                  *ngIf="getControl('type')?.value === 'snowflake'"
                  style="margin-top: 20px">
                  <button
                    mat-raised-button
                    color="primary"
                    type="button"
                    [disabled]="oauthCheckInProgress"
                    (click)="testSnowflakeOAuth()">
                    <mat-icon *ngIf="!oauthCheckInProgress"
                      >check_circle</mat-icon
                    >
                    <mat-spinner
                      *ngIf="oauthCheckInProgress"
                      diameter="20"></mat-spinner>
                    {{
                      oauthCheckInProgress
                        ? 'Checking...'
                        : 'Test OAuth Connection'
                    }}
                  </button>
                  <p
                    class="oauth-message"
                    *ngIf="oauthCheckMessage"
                    [ngClass]="{
                      success: oauthCheckSuccess,
                      error: !oauthCheckSuccess && oauthCheckMessage,
                    }">
                    {{ oauthCheckMessage }}
                  </p>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </ng-container>
      </ng-container>
    </ng-container>
    <div class="full-width action-bar" *ngIf="!subscriptionRequired">
      <button
        mat-flat-button
        class="cancel-btn"
        type="button"
        (click)="goBack()">
        {{ 'cancel' | transloco }}
      </button>
      <ng-container *ngIf="this.edit">
        <!-- <mat-button-toggle-group
          [(ngModel)]="clearCache"
          [ngModelOptions]="{ standalone: true }"
          appearance="legacy">
          <mat-button-toggle
            [value]="true"
            mat-flat-button
            class="save-btn"
            color="primary"
            (click)="save()">
            {{ 'saveAndClear' | transloco }}</mat-button-toggle
          >
        </mat-button-toggle-group> -->
        <button
          [value]="true"
          mat-flat-button
          class="save-btn"
          color="primary"
          (click)="save(true, false)">
          {{ 'saveAndClear' | transloco }}
        </button>
        <button
          [value]="true"
          mat-flat-button
          class="save-btn"
          color="primary"
          (click)="save(true, true)">
          {{ 'saveAndContinue' | transloco }}
        </button>
      </ng-container>
      <button mat-flat-button class="save-btn" color="primary">
        {{ 'save' | transloco }}
      </button>
    </div>
  </ng-template>
</form>
<df-paywall
  *ngIf="subscriptionRequired"
  [serviceName]="selectedServiceTypeLable || 'Unable to fetch service name'">
</df-paywall>
